<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
   <HEAD>
      <TITLE>LSLC Thin Sections</TITLE> <link rel='icon' type='image/x-icon' href='favicon.ico'/>
       <meta charset="UTF-8">

 
        <!--Google font-->
            <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
       
        <!-- Async from CDN -->    
            <script src="https://unpkg.com/async@2.4.0/dist/async.min.js"></script>
        <!-- docs: http://caolan.github.io/async/docs.html -->
       
       <!-- Load Leaflet from CDN-->
           <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
           <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet-src.js"></script>
       
       <!-- Load Esri Leaflet from CDN -->
            <script src="https://unpkg.com/esri-leaflet@2.0.7"></script>
 
       <!-- JQuery  -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
       
       <!-- JQuery UI  -->
            <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/themes/smoothness/jquery-ui.css">
            <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>
 
       
       <!-- local stylesheets -->
           <LINK href="generalStyle.css" rel='stylesheet'/>
           <LINK href="modalStyle.css" rel='stylesheet'/>

       
      <!-- Enable media queries for old IE -->
      <!--[if lt IE 9]>
        <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
      <![endif]-->
       
       <style>
           .galleryPageLinks{
               background-color: #e6e6e6;
           }
           .galleryPageLink {
               background-color: orange;
           }
           .galleryItemDiv {
               display: inline-block;
               margin: 5px;
               padding: 3px;
           }
           .galleryItemDiv p{
               margin: 0;
           }
           .galleryThumb{ 
                height: 150px;
           }
           
       </style>
       
</HEAD>
<BODY>
  
   <div id="header"></div>
   <div id="wrapper">
        

       <h2>Thin Sections Gallery</h2> 
        <div class="galleryPageLinks">Page:<div class="galleryPageLink">1</div></div>
       
     <!--  <div class='reportDivision'><div id="fieldNotebooksList"></div></div> -->
       <div id="thinGallery" class="divisionContent"></div>
   
       <div class="galleryPageLinks">Page:</div>
       <div id="footer"></div>
   </div><!--end wrapper div-->
   
   <!-- header js: must go after the wrapper div and header div -->
   <script src="header.js"></script>

    
    <!-- javascript links -->
    <script src="mapServiceUrls.js"></script>
    
    <!-- javascript for building the thin section gallery -->
    <script>

        //global variables: 
        var globalThinSectionGalleryArray = []; 
        
         //happens right away on page load: 
        async.series([retrieveThinSections, callSort, /*callBuild,*/ buildThinGallery.bind(null, 1, 12), initGallery], function(){
            console.log("all done. global data array: ", globalThinSectionGalleryArray);
        });
        
        function initGallery (){
            var done =  function(){console.log("done");}
            //click listeners 
            $(".galleryPageLink").on('click', function(){
                console.log("click");
                buildThinGallery(2,12,done);
            });
            
        }
        
        var thinSectionsManager = (function(){
            
            var add = function(array){
                //construct the image URL properties from the catalog number. 
                array.PPLthumbURL = 'https://geodata.wgnhs.uwex.edu/lake-superior-legacy/assets/thin-section-thumbs/'+array.CatalogNumber+'ppl_thumb.jpg'; 
                array.XPLthumbURL = 'https://geodata.wgnhs.uwex.edu/lake-superior-legacy/assets/thin-section-thumbs/'+array.CatalogNumber+'xpl_thumb.jpg'; 
                globalThinSectionGalleryArray = globalThinSectionGalleryArray.concat(array);
                
            }
            
            
            var sortByNumber = function(attr, direction){
                               
                console.log("sort by "+attr+" in "+direction+" order."); 
                
                if (direction === 'ascending'){
                
                    globalThinSectionGalleryArray.sort(function (a,b){

                        if(parseInt(a[attr]) < parseInt(b[attr])) return -1; 
                        if(parseInt(a[attr]) > parseInt(b[attr])) return 1; 
                        return 0;

                    });
                } else if (direction === 'descending'){
                    globalThinSectionGalleryArray.sort(function (a,b){

                        if(parseInt(a[attr]) > parseInt(b[attr])) return -1; 
                        if(parseInt(a[attr]) < parseInt(b[attr])) return 1; 
                        return 0;

                    });
                }
                
                console.log(globalThinSectionGalleryArray);
            }
            
            var page = function(pageNumber, pageSize){
                
                //page number arguments start at page 1,so we need to correct for zero-indexing
                var start = (pageNumber-1) * pageSize; 
                var end = start + pageSize;
                return globalThinSectionGalleryArray.slice(start,end);
                
            }
            
            //exposed methods: 
            return {
                "add": add, 
                "sortByNumber": sortByNumber,
                "page": page,
            }
        })(); //end thinSectionManager
        
        
    
       function retrieveThinSections(callback){
           //this should happen once upon page load. 
           
           var thinImagesQuery = L.esri.query({url: thinSectionsTableURL});
           thinImagesQuery.fields(["*"]); 
           
           thinImagesQuery.run(function(err, featureCollection, response){
               
               //I think Pete changed the map server so we can get over 15000 results in one query. 
               
//               console.log('response', response);
//               console.log('feature coll', featureCollection);
                         
               console.log("Query returned. global array is empty: ", globalThinSectionGalleryArray);
               
               for (i in response.features){ 
                   
                  thinSectionsManager.add(response.features[i].attributes);
               }
               callback();
               
           }); //end query.run callback

       } //end retrieveThinSections
        
        
        
        function buildThinGallery(pageNumber, pageSize, callback) {
          
            
            //reset the varible representing the contents of the gallery. 
            var divisionContent= '';
            
            var dataForDisplay = thinSectionsManager.page(pageNumber, pageSize); // .page accepts two arguments: page number then page size
            
            
            //for every thin section...
            for (i in dataForDisplay){
                var item = dataForDisplay[i];
                
                var thinDiv = '<div class="galleryItemDiv">';
                thinDiv += "<p>Thin Section #"+item.CatalogNumber+"</p>"
                thinDiv += "<img class='galleryThumb' src='"+item.PPLthumbURL+"'>";
                thinDiv += "<img class='galleryThumb' src='"+item.XPLthumbURL+"'>";

                thinDiv += "</div>";
                
                divisionContent += thinDiv;  
                
            }
            
            
            $("#thinGallery").append(divisionContent);
            
            callback();
        }
        
        function callBuild(callback){
            buildThinGallery(1,12); 
            callback();
        }
        
        function callSort(callback){
            thinSectionsManager.sortByNumber("CatalogNumber", "ascending"); 
            callback();
        }
        
       
        
    </script><!-- end javascript for building the thin section gallery -->
   
   
</BODY> 
</HTML>