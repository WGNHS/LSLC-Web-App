<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
   <HEAD>
      <TITLE>LSLC Thin Sections</TITLE> <link rel='icon' type='image/x-icon' href='favicon.ico'/>
       <meta charset="UTF-8">

 
        <!--Google font-->
            <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
       
        <!-- Async from CDN -->    
            <script src="https://unpkg.com/async@2.4.0/dist/async.min.js"></script>
        <!-- docs: http://caolan.github.io/async/docs.html -->
       
       <!-- Load Leaflet from CDN-->
           <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
           <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet-src.js"></script>
       
       <!-- Load Esri Leaflet from CDN -->
            <script src="https://unpkg.com/esri-leaflet@2.0.7"></script>
 
       <!-- JQuery  -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
       
       <!-- JQuery UI  -->
            <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/themes/smoothness/jquery-ui.css">
            <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>
 
       
       <!-- local stylesheets -->
           <LINK href="generalStyle.css" rel='stylesheet'/>
           <LINK href="modalStyle.css" rel='stylesheet'/>

       
      <!-- Enable media queries for old IE -->
      <!--[if lt IE 9]>
        <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
      <![endif]-->
       
       <style>
           h2 {
               display: inline;
               padding-right: 5px;
           }
           .galleryPageLinks{
               background-color: #e6e6e6;
           }
           .galleryPageLink {
               background-color: orange;
               display: inline-block;
           }
           .galleryPageLink:hover {
               background-color: darkgoldenrod;
               cursor: pointer;
           }
           .galleryItemDiv {
               display: inline-block;
               margin: 5px;
               padding: 3px;
           }
           .galleryItemDiv p{
               margin: 0;
           }
           .galleryThumb{ 
                height: 150px;
               width: 225px;
           }
           #thinGallery .thinSection:hover{
               background-color: #e6e6e6;
               cursor: pointer;
           }
           /*PAGINATION*/
           .galleryNav {
               background-color: #e6e6e6;
               text-align: center;
           }
           .galleryNav input{
               display: inline-block;
               text-align: center;
               width: 3em;
           }
           .galleryNav .button{
               background-color:  #b74226;
               display: inline-block;
               padding: 2px 10px;
           }
           .galleryNav .button:hover{
               background-color:  #842d1a;
               cursor: pointer;
           }
           
       </style>
       
</HEAD>
<BODY>
  
   <div id="header"></div>
   <div id="wrapper">
        <div id="modalBackground" class="modalBackground">
           <div id="modal-content"></div>
       </div> 

       <h2 id="galleryTitle">Thin Sections Gallery</h2> 
       <div class="galleryNav">
           <div id="galleryPrev" class='button'>&laquo;</div>
           <label>page </label>
           <input id="galleryPage" name="galleryPage" type="search" value="1">
           <div id="galleryNext" class='button'>&raquo;</div>
       </div>

       <div id="thinGallery" class="divisionContent"></div>
   
       <div id="footer"></div>
   </div><!--end wrapper div-->
   
   <!-- header js: must go after the wrapper div and header div -->
   <script src="header.js"></script>

    
    <!-- javascript links -->
    <script src="mapServiceUrls.js"></script>
    <script src="modal.js"></script>
    
    <!-- javascript for building the thin section gallery -->
    <script>

        //global variables: 
        var globalThinSectionGalleryArray = []; 
        var pageSize = 12; //the number of image pairs to show on each page of the gallery. 
        var currentPage = 1; //this gets reset by the buildGallery function.
        
         //happens right away on page load: 
        async.series([retrieveThinSections, callSort, callBuild, initGallery], function(){
            console.log("all done. global data array: ", globalThinSectionGalleryArray);
        });
        
        function initGallery (){
            
            //delegated click listener for launching the modal: 
            $("#thinGallery").on('click','.thinSection', function(){
                console.log("view modal for thin section #", $(this).data('thinID'));
                
                modal.thinSectionViewer($(this).data('thinID'));
            });
              
        }
        
        var thinSectionsManager = (function(){
            
            var add = function(array){
                //construct the image URL properties from the catalog number. 
                array.PPLthumbURL = 'https://geodata.wgnhs.uwex.edu/lake-superior-legacy/assets/thin-section-thumbs/'+array.CatalogNumber+'ppl_thumb.jpg'; 
                array.XPLthumbURL = 'https://geodata.wgnhs.uwex.edu/lake-superior-legacy/assets/thin-section-thumbs/'+array.CatalogNumber+'xpl_thumb.jpg'; 
                globalThinSectionGalleryArray = globalThinSectionGalleryArray.concat(array);
                
            }
            
            
            var sortByNumber = function(attr, direction){
                               
                console.log("sort by "+attr+" in "+direction+" order."); 
                
                if (direction === 'ascending'){
                
                    globalThinSectionGalleryArray.sort(function (a,b){

                        if(parseInt(a[attr]) < parseInt(b[attr])) return -1; 
                        if(parseInt(a[attr]) > parseInt(b[attr])) return 1; 
                        return 0;

                    });
                } else if (direction === 'descending'){
                    globalThinSectionGalleryArray.sort(function (a,b){

                        if(parseInt(a[attr]) > parseInt(b[attr])) return -1; 
                        if(parseInt(a[attr]) < parseInt(b[attr])) return 1; 
                        return 0;

                    });
                }
                
                console.log(globalThinSectionGalleryArray);
            }
            
            var page = function(pageNumber, pageSize){
                
                //page number arguments start at page 1,so we need to correct for zero-indexing
                var start = (pageNumber-1) * pageSize; 
                var end = start + pageSize;
                return globalThinSectionGalleryArray.slice(start,end);
                
            }
            
            //exposed methods: 
            return {
                "add": add, 
                "sortByNumber": sortByNumber,
                "page": page,
            }
        })(); //end thinSectionManager
        
        
    
       function retrieveThinSections(callback){
           //this should happen once upon page load. 
           
           var thinImagesQuery = L.esri.query({url: thinSectionsTableURL});
           thinImagesQuery.fields(["*"]); 
           
           thinImagesQuery.run(function(err, featureCollection, response){
               
               //I think Pete changed the map server so we can get over 15000 results in one query. 
               
               buildGalleryNav(response.features.length, pageSize); 
               
               for (i in response.features){ 
                   
                  thinSectionsManager.add(response.features[i].attributes);
               }
               callback();
               
           }); //end query.run callback

       } //end retrieveThinSections
        
        function buildGalleryNav (resultsTotal, pageSize) {
            //should be called once on page initialization. 
             var numberOfPages = Math.ceil(resultsTotal/pageSize); 
            
            $("#galleryTitle").after("<span>("+resultsTotal+" found)</span>");
            $("#galleryPage").after("<span> of "+numberOfPages+"</span>");

            console.log("build a page nav for ", resultsTotal, "results.", numberOfPages, "pages."); 
            
            
            //input listener for page number input: 
            $("#galleryPage").on("input", function(){
                var newPage = $("#galleryPage").val();
                
                console.log("change to page", newPage);
                buildThinGallery(newPage, pageSize);
                
            });
            //input listener for next and previous buttons: 
            $("#galleryNext").click(function(){
                var newPage = parseInt(currentPage)+1;
                
                buildThinGallery(newPage, pageSize);
     
            });
            $("#galleryPrev").click(function(){
                var newPage = parseInt(currentPage)-1;
                
                buildThinGallery(newPage, pageSize);
     
            });
            
            

            
        }
        
        function buildThinGallery(pageNumber, pageSize) {
            //called every time a new page is displayed
            
            //reset the global var representing the current page: 
            currentPage = pageNumber;
            //change the page input value: 
            $("#galleryPage").val(currentPage);
            
            //reset the varible representing the contents of the gallery. 
            var galleryContent= $("<div></div>");
            
            var dataForDisplay = thinSectionsManager.page(pageNumber, pageSize); // .page accepts two arguments: page number then page size
            
            
            //for every thin section...
            for (i in dataForDisplay){
                var item = dataForDisplay[i];
                
                var thinSec = $('<div class="thinSection"></div>').html("<p>Thin Section #"+item.CatalogNumber+"</p>");
                
                thinSec.append("<img class='galleryThumb' src='"+item.PPLthumbURL+"'>");
                thinSec.append("<img class='galleryThumb' src='"+item.XPLthumbURL+"'>");
                thinSec.addClass("galleryItemDiv");
                thinSec.attr('title','click to view');

                thinSec.data({"thinID": item.CatalogNumber/*, "handSampleCatalogNumber": 1*/});
                
                galleryContent.append(thinSec);  
                
            }
            
            //replace the contents of the gallery div with the updated content variable. 
            $("#thinGallery").html(galleryContent);
      
        }
        
        function callBuild(callback){
            buildThinGallery(1,pageSize); 
            callback();
        }
        
        function callSort(callback){
            thinSectionsManager.sortByNumber("CatalogNumber", "ascending"); 
            callback();
        }
        
       
    </script><!-- end javascript for building the thin section gallery -->
   
   
</BODY> 
</HTML>