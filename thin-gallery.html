<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
   <HEAD>
      <TITLE>LSLC Thin Sections</TITLE> <link rel='icon' type='image/x-icon' href='favicon.ico'/>
       <meta charset="UTF-8">

 
        <!--Google font-->
            <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
       
        <!-- Async from CDN -->    
            <script src="https://unpkg.com/async@2.4.0/dist/async.min.js"></script>
        <!-- docs: http://caolan.github.io/async/docs.html -->
       
       <!-- Load Leaflet from CDN-->
           <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
           <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet-src.js"></script>
       
       <!-- Load Esri Leaflet from CDN -->
            <script src="https://unpkg.com/esri-leaflet@2.0.7"></script>
 
       <!-- JQuery  -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
       
       <!-- JQuery UI  -->
            <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/themes/smoothness/jquery-ui.css">
            <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>
       
       <!-- Lazy Load --> 
            <script src="https://unpkg.com/jquery-lazy@1.7.5"></script>
      
       
       <!-- local stylesheets -->
           <LINK href="generalStyle.css" rel='stylesheet'/>
           <LINK href="modalStyle.css" rel='stylesheet'/>

       
      <!-- Enable media queries for old IE -->
      <!--[if lt IE 9]>
        <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
      <![endif]-->
       
       <style>
           .galleryImageDiv {
               display: inline-block;
           }
       </style>
       
</HEAD>
<BODY>
  
   <div id="header"></div>
   <div id="wrapper">
        

       <h2>Thin Sections Gallery</h2> 
       <span>Mouse-over to view cross-polarized images</span>
       
     <!--  <div class='reportDivision'><div id="fieldNotebooksList"></div></div> -->
       <div id="thinGallery" class="divisionContent"></div>
   
       
       <div id="footer"></div>
   </div><!--end wrapper div-->
   
   <!-- header js: must go after the wrapper div and header div -->
   <script src="header.js"></script>

    
    <!-- javascript links -->
    <script src="mapServiceUrls.js"></script>
    
    <!-- javascript for building the thin section gallery -->
    <script>
        $(function() {
            $('.lazy').Lazy({
                // your configuration goes here
                scrollDirection: 'vertical',
                effect: 'fadeIn',
                visibleOnly: true,
                onError: function(element) {
                    console.log('error lazy-loading: ' + element.data('src'));
                }
            });
        });
        
        //global variables: 
        var globalThinSectionGalleryArray = []; 
        
        var thinSectionsManager = (function(){
            
            var add = function(array){
                //construct the image URL properties from the catalog number. 
                array.PPLthumbURL = 'https://geodata.wgnhs.uwex.edu/lake-superior-legacy/assets/thin-section-thumbs/'+array.CatalogNumber+'ppl_thumb.jpg'; 
                array.XPLthumbURL = 'https://geodata.wgnhs.uwex.edu/lake-superior-legacy/assets/thin-section-thumbs/'+array.CatalogNumber+'xpl_thumb.jpg'; 
                globalThinSectionGalleryArray = globalThinSectionGalleryArray.concat(array);
                
            }
            
            
            var sortByNumber = function(attr, direction){
                               
                console.log("sort by "+attr+" in "+direction+" order."); 
                
                if (direction === 'ascending'){
                
                    globalThinSectionGalleryArray.sort(function (a,b){

                        if(parseInt(a[attr]) < parseInt(b[attr])) return -1; 
                        if(parseInt(a[attr]) > parseInt(b[attr])) return 1; 
                        return 0;

                    });
                } else if (direction === 'descending'){
                    globalThinSectionGalleryArray.sort(function (a,b){

                        if(parseInt(a[attr]) > parseInt(b[attr])) return -1; 
                        if(parseInt(a[attr]) < parseInt(b[attr])) return 1; 
                        return 0;

                    });
                }
                
                console.log(globalThinSectionGalleryArray);
            }
            
            //exposed methods: 
            return {
                "add": add, 
                "sortByNumber": sortByNumber,
            }
        })(); //end thinSectionManager
        
        
    
       function retrieveThinSections(callback){
           //this should happen once upon page load. 
           
           var thinImagesQuery = L.esri.query({url: thinSectionsTableURL});
           thinImagesQuery.fields(["*"]); 
           
           thinImagesQuery.run(function(err, featureCollection, response){
//               console.log('response', response);
//               console.log('feature coll', featureCollection);
                         
               console.log("Query returned. global array is empty: ", globalThinSectionGalleryArray);
               
               for (i in response.features){ 
                   
                  thinSectionsManager.add(response.features[i].attributes);
               }
               callback();
               
           }); //end query.run callback

       } //end retrieveThinSections
        
        function consoleAfter(callback) {
            console.log("after query? ");
            callback();
        }
        
        function replaceThumbnailImage(number){
            var PPLthumbURL = 'https://geodata.wgnhs.uwex.edu/lake-superior-legacy/assets/thin-section-thumbs/'+number+'xpl_thumb.jpg';
            
            var testImage = new Image(); 
            
            
            testImage.onload = function(){
                //successfully found the new image.  
                console.log("image found");
                //replace the image in the html page. 
                console.log("element", $("#pplthumb_"+number));
                
                
               $("#pplthumb_"+number).attr('src', testImage.src);
                
                
                //replace the data attribute in the global data array
                for(i in globalThinSectionGalleryArray){
                    if (globalThinSectionGalleryArray[i].CatalogNumber === number){
                        globalThinSectionGalleryArray[i].PPLthumbURL = testImage.src;
                    }
                }
                console.log("global array: ", globalThinSectionGalleryArray);
                
                
            }
            
            testImage.src= PPLthumbURL;
            
            
        }
        
        function replaceDataAttribute(){
            
        }
        
        function replaceImages(){
            
           // var subset = [{"CatalogNumber": "1"}, {"CatalogNumber": "2"}, {"CatalogNumber": "11"}, {"CatalogNumber": "12"}, {"CatalogNumber": "13"}];
            
            for (var i = 0; i < 1000; i++){
                thinNumber = globalThinSectionGalleryArray[i].CatalogNumber;
              //  thinNumber = subset[i].CatalogNumber;
                replaceThumbnailImage(thinNumber);
               
            }
                
            
        }
        
        function buildThinGallery(callback) {
            var divisionContent= '';
            
            //for every thin section...
            for (i in globalThinSectionGalleryArray.slice(0,100)){
               // console.log("item", globalThinSectionGalleryArray[i]);
                
                var thinDiv = '<div class="galleryImage">';
                
                thinDiv += "<img class='lazy' src='images/notebooks/notebook-icon.jpg' data-src='"+globalThinSectionGalleryArray[i].PPLthumbURL+"' id='pplthumb_"+globalThinSectionGalleryArray[i].CatalogNumber+"'/>";
                
                thinDiv += globalThinSectionGalleryArray[i].CatalogNumber;
                
                thinDiv += "</div>";
                
                divisionContent += thinDiv;
                
                
            }
            
            
            $("#thinGallery").append(divisionContent);
            
            callback();
        }
        
        function callSort(callback){
            thinSectionsManager.sortByNumber("CatalogNumber", "ascending"); 
            callback();
        }
        
        async.series([retrieveThinSections, callSort, buildThinGallery, /*replaceImages,*/ consoleAfter], function(){
            console.log("all done. global data array: ", globalThinSectionGalleryArray);
        });
        
        
    </script><!-- end javascript for building the thin section gallery -->
   
   
</BODY> 
</HTML>