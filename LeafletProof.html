<html>
<head>
  <meta charset=utf-8 />
  <title>Proof of Concept</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <!-- Load Leaflet from CDN-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet-src.js"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.0.7"></script>

  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:0; bottom:0; right:0; left:0; }
  </style>
</head>
<body>
<!-- load the latest release from the cdn -->
<script src="https://unpkg.com/esri-leaflet-vector"></script>
    
<div id="map"></div>

<script>
//array of section ids containing granite, copied and pasted from console of LSLC Map View
//this mimics our incoming array from queryTableForFilters()
var array = [128743,183356,64592,64309,128457,128457,128457,199279,199279,199279,199438,170250,176397,62950,62946,62946,63139,65088,74458,62536,62530,62733,62946,74458,62343,2648,63901,199562,199578,200782,200564,199962,201384,201627,200881,201067,200235,200141,200025,199535,199188,128488,128488,199578,127317,198998,198948,198988,198670,198606,198447,132538,132101,132103,131862,140422,198986,198932,198959,198996,198678,198447,63408,200025,199908,128488,199578,199533,132327,2648,2648,63825,63649,63776,3684,3803,200235,199532,140422,167561,165608,137476,137485,137485,137496,137496,137265,137806,138052,140202,141722,141722,141289,141289,141289,200558,199078,199159,199159,2648,2649,199011,199108,199159,199159,128480,129758,130664,63757,63757,63789,64040,64040,64040,64040,64040,64040,63435,63301,63301,62504,62504,65570,64700,62985,62985,72748,72748,72748,72748,72748,72748,72748,62742,62742,62742,62746,63166,62742,62946,62946,62946,62946,63612,63612,62921,63358,63358,62517,62725,62938,60781,60781,61216,62559,62569,61520,62832,62418,199439,199439,60932,61586,132324,63927,63446,63017,63006,63683,63683,63446,63230,63438,63432,63432,63658,63432,63476,63476,63253,63936,63688,63683,67137,63653,63653,63653,64411,64411,64700,64700,64700,64700,64700,64703,64987,64987,64987,64987,64993,65279,65279,63446,63653,63891,63891,63888,63888,63888,63888,64425,64425,64425,64987,65282,65282,64683,118804,118804,118804,197884,197860,197863,197853,197839,197839,72927,72927,72266,72266,72931,72934,72281,72938,72737,72525,72525,72527,72744,72760,72755,72548,72548,72558,64916,64916,65192,65188,65469,65469,65480,65480,64903,66121,67492,63336,64620,64620,64610,64610,65279,64993,64993,66122,66122,66122,66122,66122,65570,65570,69545,69788,70261,70261,69285,69285,69275,69035,68525,68781,68261,66619,69334,67994,68084,68251,68251,66904,64610,64610,64610,63336,136195,136198,141072,140862,140862,140648,140648,137255,137488,137249,137321,64525,64802,64821,64827,63786,64847,64866,64866,64866,64872,64878,64872,64872,64872,67984,67716,67971,67152,67148,67148,67144,68117,68125,68860,69351,70331,70354,68191,67977,67705,67705,67977,67977,64500,64866,64866,71848,71848,71848,71848,72760,72744,72744,64610,64610,62848,62646,62646,62646,62646,62646,62646,62848,62921,62926,65163,62859,62869,63066,63261,62921,63139,62931,63143,63143,63143,63146,63146,62934,63150,62946,62516,62731,62731,62733,62525,62526,62528,62526,65169,65163,62927,63139,62734,62734,62934,62938,62938,70982,70961,71742,65169,65157,64608,64077,65169,65163,65163,64079,64351,63843,65162,65162,65162,65162,65162,64884,64866,64866,63201,63201,68520,67188,68261,67467,70961,204140,204136,204136,204140,204136,204140,204140,204136,72095,71841,71569,74279,74366,72927,71848,74282,74371,74457,74458,74458,74370,74370,74706,74709,74115,71638,71658,132305,132305,132305,132744,132523,134141,133008,133008,201374,200571,199984,66611,68514,69281,6858,71979,71979,71962,72451,72220,72690,73501,73488,68251,69035,68774,70961,6861,6861,6861,72199,72431,72217,72217,72448,72448,72220,72220,72485,72920,72916,72897,73154,73156,73144,72558,72558,73329,73325,73602,71834,71979,68767,69275,72189,72189,72189,72189,71952,72189,72189,72199,72199,73161,73827,73824,132305,132085,132751,132730,133651,133892,200815,133475,133475,132083,132972,132952,201009,201009,200479,200561,200656,200656,200656,199929,200049,200138,199913,200000,200000,199191,200138,200102,200756,200650,200650,200181,199902,199902,200266,199438,200774,200776,200776,200668,200668,200668,200664,200660,200659,200659,200553,200545,200084,200141,200254,199187,199535,199532,199075,199191,199191,132744,132521,199514,132751,133000,132751,133000,128486,200490,200490,199695,200782,199962,200774,199876,199805,199187,133915,200110,200900,132761,137255,138919,138920,137792,199491,136824,202068,202068,74095,137292,63345,72477,72477,72735,72752,72752,72752,72752,72752,72752,72737,72737,72744,72744,72748,72748,72748,72748,72748,72752,72752,72752,72752,72752,72752,72752,72755,9484,9484,9033,73156,8809,8809,6649,6861,6651,137255,137444,137229,137004,137004,137004,137805,138035,138047,138283,138283,138283,138295,138295,138295,138295,138480,138480,138479,139990,140858,141722,141722,62129,62946,63143,63139,63255,62565,62565,160727,162701,160696,62941,63166,200659,128488,62977,36188,64618,64620,64610,63481,63497,63497,63509,64513,64513,64516,64520,63300,64520,64520,64827,64827,64862,64866,63528,63289,63289,63064,63064,62848,62848,62646,62646,62646,62848,63064,63064,63261,63261,63261,63261,63261,63261,63261,63261,63261,63261,63054,63040,63040,63028,63028,62820,63018,63018,62921,62926,64872,64862,64862,64862,64866,64866,65163,65162,65163,64878,65163,64077,64077,63300,63312,63312,63086,63086,63300,63066,63086,63066,63066,63274,63497,63509,63497,63497,63274,63064,62845,62640,62640,62640,62640,62845,62845,63054,63054,63258,63261,63258,63258,62921,63137,62926,65169,65163,63139,62941,61697,61697,61499,61287,61857,61871,62312,62312,62516,62315,62315,61917,62120,62321,62321,62327,62734,65169,65169,65169,65163,65163,65163,65163,64884,65162,63671,6651,6858,73098,73299,73148,73148,63688,64449,64449,64174,64164,64435,64708,64708,64708,64716,64708,64993,64723,65010,65288,63930,63930,65283,65859,65018,66147,66438,65327,71841,63843,63843,63843,63843,63843,63845,65162,65162,65162,65162,65162,65157,64878,64878,65173,64891,64079,63843,63845,63258,63476,63476,63911,63911,63671,63911,63896,64159,63893,63658,63432,64153,64149,64728,64187,64466,64467,64757,65605,66472,65058,64780,66010,65429,66015,68767,68514,64620,72217,72314,73824,73928,74001,73299,74183,74370,74459,74026,132083,134138,133447,132949,132949,200697,200375,200375,200256,201293,200359,200110,200110,200141,200266,200000,199695,200466,199962,200865,199875,200025,199913,200348,200241,199662,199733,199842,199842,200138,199908,199449,199191,63911,64732,64732,65010,68589,68781,68494,68494,68767,68507,70261,70982,70961,70961,70961,70493,70961,64683,63255,63336,63301,63435,64040,64040,200782,74457,74457,10085,64620,64620,62921,62921,63201,62539,62956,30959,31211,31211,31211,31211,34982,34535,34535,26904,27179,27702,27703,27703,29070,168328,168335,168338,167164,167368,167561,167561,167365,167365,167167,167362,167167,167365,166969,165174,166035,181771,181553,181123,199578,199520,199562,199763,199078,199078,199078,199071]

    
//++++++++++++++LINES 31â€“109 FROM highlightMap()++++++++++++++++++++++++++++++++++
//these are called with above array
    var sortedArray = array.sort(function(a,b){return a-b});
    var filteredSections = [];

    for (i = 0; i < sortedArray.length; i++){
      if (sortedArray[i] != sortedArray[i-1]) {
        filteredSections.push(sortedArray[i]);
      }
    }

    
        //PART THAT HIGHLIGHS THE MAP COMMENTED OUT

        // var mapHighlight = new Query();
        // mapHighlight.where = ('UID IN ('+filteredSections+')');

        // fl.selectFeatures(mapHighlight, fl.SELECTION_NEW); 
        //zoom to the extent of the filter results.

        //CHOROPLETH-----------------------------------------
        var choroplethStructureArray = [];
        //populates 2D array with [[sectionID, # of records in it],,]
        for (i = 0; i < sortedArray.length; i++){
          if (sortedArray[i] != sortedArray[i-1]){
            choroplethStructureArray.push([sortedArray[i], 1]);
          } else {
            choroplethStructureArray[choroplethStructureArray.length-1][1]++;
          }
        }

        //creates array with just the # of records; later used to find class breaks
        var classBreaksFinderArray = [];
        for (i = 0; i < choroplethStructureArray.length; i++){
          classBreaksFinderArray.push(choroplethStructureArray[i][1]);
        }

        //sorts the array containing # of samples; sorts and filteres ot redundant values
        //gives us unique count numbers
        var sortedClassFinderArray = classBreaksFinderArray.sort(function(a,b){return a-b});
        var filteredValuesArray = [];
        for (i = 0; i < sortedClassFinderArray.length; i++){
          if (sortedClassFinderArray[i] != sortedClassFinderArray[i-1]) {
            filteredValuesArray.push(sortedClassFinderArray[i])
          }
        }

        //sets up 4 class break values using jerry-rigged equal interval -- maybe switch and import D3?
        var break0 = filteredValuesArray[0];
        var break1 = filteredValuesArray[Math.round((filteredValuesArray.length / 4) - 1)];
        var break2 = filteredValuesArray[Math.round((filteredValuesArray.length / 2) - 1)];
        var break3 = filteredValuesArray[Math.round((filteredValuesArray.length / (4/3)) - 1)];
        var breakTop = filteredValuesArray[filteredValuesArray.length - 1];

        //defines arrays to be populated with section ids in each class
        var class1Array = [];
        var class2Array = [];
        var class3Array = [];
        var class4Array = [];

        //populates each class array by checking how many samples they each have, evaluating via breaks
        //makes use of the 2D choroplethStructureArray
        for (i = 0; i < choroplethStructureArray.length; i++){
          if (choroplethStructureArray[i][1] <= break1){
            class1Array.push(choroplethStructureArray[i][0]);
          } else if (choroplethStructureArray[i][1] <= break2) {
            class2Array.push(choroplethStructureArray[i][0]);
          } else if (choroplethStructureArray[i][1] <= break3) {
            class3Array.push(choroplethStructureArray[i][0]);
          } else {
            class4Array.push(choroplethStructureArray[i][0]);
          }; 
        } 

        // tests out how the choropleth system is working
        console.log("filtered values array -->", filteredValuesArray)
        console.log("class breaks -->", break0,break1,break2,break3,breakTop)
        console.log("class 1 array:", class1Array)
        console.log("class 2 array:", class2Array)
        console.log("class 3 array:", class3Array)
        console.log("class 4 array:", class4Array)

//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

  var map = L.map('map').setView([ 47, -90], 7); //sets up esri leaflet map

  //basemap -- default
  L.esri.basemapLayer('Gray').addTo(map); 
  L.esri.basemapLayer('GrayLabels').addTo(map);
  //  L.esri.Vector.basemap('ModernAntique').addTo(map);
    
  //connects to our database
  L.esri.featureLayer({
    //url is copied from New Feature Layer at top of MapAndQuery.js
    url: 'http://geodata.wgnhs.uwex.edu/arcgis/rest/services/lslc/lslc/MapServer/0',
   // simplifyFactor: 0.5, //not sure didn't change
    //precision: 5, //not sure didn't change

    //this loops through every section -- not sure where the loop syntax is, probably esri leaflet method 
    style: function (feature) {

      var fillColor; //blank variable for fill color
      var sectionID = feature.properties.UID; //pulls out section id from feature

      //checks to see if the section id of the feature is located in any of the class arrays
      //if so gives it a choropleth color
      //choropleth colors are all dark; starts half way up 8 class color brewer scheme to stand out in visual hierarchy even if value 1
      if ( class4Array.indexOf(sectionID) != -1 ) fillColor = "#8c2d04";
      else if ( class3Array.indexOf(sectionID) != -1) fillColor = "#cc4c02";
      else if ( class2Array.indexOf(sectionID) != -1) fillColor = "#ec7014";
      else if ( class1Array.indexOf(sectionID) != -1 ) fillColor = "#fe9929";
      //if not found in any class array, given no-value color
      else fillColor = "#ece7f2";  // opposite hue, low saturation, slightly diverging to show seperation

      //actual style declaration for each feature using assignment from above
      return { color: "#999", weight: 0.35, fillColor: fillColor, fillOpacity: .9 };

    } //end of style loop
  }).addTo(map); //adds to map
</script>

</body>
</html>

